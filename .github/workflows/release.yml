name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      python_repository:
        description: "Python publish target"
        required: true
        default: "none"
        type: choice
        options:
          - none
          - testpypi
          - pypi
      publish_npm:
        description: "Publish @llm-jury/core to npm"
        required: true
        default: false
        type: boolean
      tag:
        description: "Git tag to publish (example: v0.1.0)"
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Validate release metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      ref: ${{ steps.meta.outputs.ref }}
    steps:
      - name: Resolve tag and version
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            tag="${{ github.ref_name }}"
          else
            tag="${{ inputs.tag }}"
          fi

          if [[ -z "$tag" || "$tag" != v* ]]; then
            echo "Tag must start with 'v' (example: v0.1.0)."
            exit 1
          fi

          version="${tag#v}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "ref=refs/tags/$tag" >> "$GITHUB_OUTPUT"

      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.ref }}

      - name: Validate package versions match tag
        env:
          EXPECTED_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import tomllib
          from pathlib import Path

          expected = os.environ["EXPECTED_VERSION"]
          pyproject = tomllib.loads(Path("packages/python/pyproject.toml").read_text(encoding="utf-8"))
          py_version = pyproject["project"]["version"]
          ts_version = json.loads(Path("packages/typescript/package.json").read_text(encoding="utf-8"))["version"]

          errors = []
          if py_version != expected:
            errors.append(f"Python version mismatch: expected {expected}, found {py_version}")
          if ts_version != expected:
            errors.append(f"TypeScript version mismatch: expected {expected}, found {ts_version}")

          if errors:
            raise SystemExit("\n".join(errors))
          print(f"Version check passed: {expected}")
          PY

  build-python:
    name: Build Python distributions
    needs: [prepare, test-python, test-typescript]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build sdist and wheel
        working-directory: packages/python
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: packages/python/dist/*

  test-python:
    name: Test Python package
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: packages/python
        run: pip install -e ".[dev]"

      - name: Run Python tests
        working-directory: packages/python
        run: python -m pytest tests/ -v

  test-typescript:
    name: Test TypeScript package
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install TypeScript dependencies
        working-directory: packages/typescript
        run: npm install

      - name: Run TypeScript tests
        working-directory: packages/typescript
        run: npm test

  publish-testpypi:
    name: Publish to TestPyPI
    needs: [prepare, build-python]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.python_repository == 'testpypi' }}
    runs-on: ubuntu-latest
    environment: testpypi
    permissions:
      id-token: write
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist

      - name: Publish package distributions to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist
          skip-existing: true

  publish-pypi:
    name: Publish to PyPI
    needs: [prepare, build-python]
    if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.python_repository == 'pypi') }}
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          skip-existing: true

  publish-npm:
    name: Publish to npm
    needs: [prepare, test-typescript]
    if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.publish_npm) }}
    runs-on: ubuntu-latest
    environment: npm
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Install package dependencies
        working-directory: packages/typescript
        run: npm install

      - name: Publish @llm-jury/core
        working-directory: packages/typescript
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --provenance
